rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // FONCTIONS DE SECURITE
    // ========================================

    // Verifier si l'utilisateur est connecte
    function signedIn() {
      return request.auth != null;
    }

    // Obtenir le document utilisateur courant
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Verifier si l'utilisateur est admin
    function isAdmin() {
      return signedIn() && getUserData().role == "admin";
    }

    // Verifier si l'utilisateur est admin ou gestionnaire
    function isAdminOrGestionnaire() {
      return signedIn() && getUserData().role in ["admin", "gestionnaire"];
    }

    // Verifier si l'utilisateur est prof
    function isProf() {
      return signedIn() && getUserData().role == "prof";
    }

    // Verifier si l'utilisateur est eleve
    function isEleve() {
      return signedIn() && getUserData().role == "eleve";
    }

    // Verifier si l'utilisateur est parent
    function isParent() {
      return signedIn() && getUserData().role == "parent";
    }

    // Verifier si l'utilisateur est staff (admin, gestionnaire, prof)
    function isStaff() {
      return signedIn() && getUserData().role in ["admin", "gestionnaire", "prof"];
    }

    // ========================================
    // FONCTIONS MULTI-TENANT
    // ========================================

    // Obtenir le schoolId de l'utilisateur courant
    function getUserSchoolId() {
      return getUserData().schoolId;
    }

    // Verifier qu'un document appartient a l'ecole de l'utilisateur
    function belongsToUserSchool() {
      return resource.data.schoolId == getUserSchoolId();
    }

    // Verifier qu'un nouveau document a le bon schoolId
    function createdWithUserSchool() {
      return request.resource.data.schoolId == getUserSchoolId();
    }

    // Verifier si l'utilisateur est un super admin
    function isSuperAdmin() {
      return signedIn() && exists(/databases/$(database)/documents/superadmins/$(request.auth.uid));
    }

    // ========================================
    // REGLES PAR COLLECTION
    // ========================================

    // USERS - Seuls les admins peuvent creer/modifier des utilisateurs
    match /users/{userId} {
      // Lecture: staff peut voir tous, les autres seulement eux-memes
      allow read: if isStaff() || request.auth.uid == userId;

      // Creation: admin uniquement
      allow create: if isAdmin();

      // Modification: admin peut tout modifier, les autres seulement leur lastSeen
      allow update: if isAdmin() ||
        (request.auth.uid == userId &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastSeen']));

      // Suppression: admin uniquement
      allow delete: if isAdmin();
    }

    // ELEVES - Staff peut gerer, parents/eleves lecture limitee
    match /eleves/{eleveId} {
      // Lecture: staff complet, parent si enfant, eleve si lui-meme
      allow read: if isStaff() ||
        (isParent() && eleveId in getUserData().enfantsIds) ||
        (isEleve() && getUserData().eleveId == eleveId);

      // Ecriture: admin et gestionnaire uniquement
      allow write: if isAdminOrGestionnaire();
    }

    // PROFESSEURS - Staff peut gerer
    match /professeurs/{profId} {
      allow read: if isStaff() ||
        (isProf() && getUserData().professeurId == profId);
      allow write: if isAdminOrGestionnaire();
    }

    // COURS - Staff peut gerer, eleves/parents lecture de leur classe
    match /cours/{coursId} {
      allow read: if isStaff() ||
        (isEleve() && resource.data.classe == get(/databases/$(database)/documents/eleves/$(getUserData().eleveId)).data.classe) ||
        isParent();
      allow write: if isStaff();
    }

    // PRESENCES - Staff peut gerer, eleves/parents lecture limitee
    match /presences/{coursId} {
      allow read: if isStaff();
      allow create: if isStaff();
      allow update: if isStaff();
      allow delete: if isAdminOrGestionnaire();

      // Subcollection appels (Pattern B: /presences/{coursId}/appels/{eleveId})
      match /appels/{eleveId} {
        allow read: if isStaff() ||
          (isEleve() && getUserData().eleveId == eleveId) ||
          (isParent() && eleveId in getUserData().enfantsIds);
        allow write: if isStaff();
      }
    }

    // PAIEMENTS - Donnees sensibles, acces tres restreint
    match /paiements/{paiementId} {
      // Lecture: admin/gestionnaire complet, parent si son enfant
      allow read: if isAdminOrGestionnaire() ||
        (isParent() && resource.data.eleveId in getUserData().enfantsIds);

      // Ecriture: admin et gestionnaire uniquement
      allow write: if isAdminOrGestionnaire();
    }

    // DISCIPLINE - Staff peut gerer
    match /discipline/{docId} {
      allow read: if isStaff() ||
        (isParent() && resource.data.eleveId in getUserData().enfantsIds) ||
        (isEleve() && resource.data.eleveId == getUserData().eleveId);
      allow write: if isStaff();
    }

    // DISCIPLINE LOGS - Admin/gestionnaire uniquement
    match /discipline_logs/{docId} {
      allow read, write: if isAdminOrGestionnaire();
    }

    // CAHIER DE TEXTE - Staff peut lire, ecriture par prof/admin
    match /cahier/{docId} {
      allow read: if isStaff();
      // Prof peut creer/modifier ses propres entrees, admin peut tout modifier
      allow create: if isStaff();
      allow update: if isAdmin() || (isProf() && resource.data.profId == request.auth.uid);
      allow delete: if isAdminOrGestionnaire();
    }

    // MESSAGES - Tous peuvent lire/ecrire leurs messages
    match /messages/{messageId} {
      allow read: if signedIn();
      allow create: if signedIn();
      // Seul l'auteur ou admin peut supprimer
      allow delete: if isAdmin() || resource.data.senderId == request.auth.uid;
      // Modification: seul admin ou auteur, et seulement certains champs
      allow update: if (isAdmin() || resource.data.senderId == request.auth.uid) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt', 'deletedAt']);
    }

    // ALERTS - Admin/gestionnaire peuvent gerer, tous peuvent lire
    match /alerts/{alertId} {
      allow read: if signedIn();
      allow write: if isAdminOrGestionnaire();
    }

    // CLASSES - Staff peut gerer, tous peuvent lire
    match /classes/{classeId} {
      allow read: if signedIn();
      allow write: if isAdminOrGestionnaire();
    }

    // CORBEILLE - Admin uniquement
    match /corbeille/{docId} {
      allow read, write: if isAdmin();
    }

    // CONNECTION LOGS - Admin/gestionnaire lecture, systeme ecriture
    match /connection_logs/{logId} {
      // Lecture: admin/gestionnaire uniquement
      allow read: if isAdminOrGestionnaire();
      // Ecriture: utilisateur connecte peut creer son propre log
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      // Mise a jour: seulement pour ajouter logoutAt sur son propre log
      allow update: if signedIn() && resource.data.userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['logoutAt']);
      // Suppression: admin uniquement
      allow delete: if isAdmin();
    }

    // ONLINE USERS - Chaque utilisateur gere sa propre entree
    match /online_users/{userId} {
      allow read: if isAdminOrGestionnaire();
      allow create, update: if signedIn() && request.auth.uid == userId;
      allow delete: if signedIn() && (request.auth.uid == userId || isAdmin());
    }

    // DEPENSES - Admin/gestionnaire uniquement
    match /depenses/{depenseId} {
      allow read, write: if isAdminOrGestionnaire();
    }

    // SALAIRES - Admin/gestionnaire uniquement
    match /salaires/{salaireId} {
      allow read, write: if isAdminOrGestionnaire();
    }

    // AUDIT LOGS - Admin/gestionnaire lecture, ecriture par CF
    match /audit_logs/{logId} {
      allow read: if isAdminOrGestionnaire();
      allow write: if false;
    }

    // CONFIG - Admin uniquement
    match /config/{docId} {
      allow read: if isAdminOrGestionnaire();
      allow write: if isAdmin();
    }

    // MATIERES - Staff peut lire, admin/gestionnaire peut gerer
    match /matieres/{matiereId} {
      allow read: if signedIn();
      allow write: if isAdminOrGestionnaire();
    }

    // EMPLOI DU TEMPS
    match /emploi_du_temps/{creneauId} {
      allow read: if signedIn();
      allow write: if isAdminOrGestionnaire();
    }

    // EVALUATIONS - Staff peut gerer, eleves/parents lecture de leur classe
    match /evaluations/{evaluationId} {
      allow read: if isStaff() ||
        (isEleve() && resource.data.classe == get(/databases/$(database)/documents/eleves/$(getUserData().eleveId)).data.classe) ||
        isParent();
      allow create, update: if isStaff();
      allow delete: if isAdminOrGestionnaire();
    }

    // NOTES - Staff peut gerer, eleves/parents lecture limitee
    match /notes/{noteId} {
      allow read: if isStaff() ||
        (isEleve() && resource.data.eleveId == getUserData().eleveId) ||
        (isParent() && resource.data.eleveId in getUserData().enfantsIds);
      allow create, update: if isStaff();
      allow delete: if isAdminOrGestionnaire();
    }

    // NOTIFICATIONS - Chacun voit ses notifications
    match /notifications/{notifId} {
      allow read: if signedIn() && resource.data.recipientId == request.auth.uid;
      allow update: if signedIn() && resource.data.recipientId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'readAt']);
      allow create: if isStaff();
      allow delete: if isAdmin();
    }

    // NOTIFICATION CONFIG - Admin uniquement
    match /notification_config/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // BULLETINS - Staff peut gerer, eleves/parents lecture limitee
    match /bulletins/{bulletinId} {
      allow read: if isStaff() ||
        (isEleve() && resource.data.eleveId == getUserData().eleveId) ||
        (isParent() && resource.data.eleveId in getUserData().enfantsIds);
      allow create, update: if isStaff();
      allow delete: if isAdmin();
    }

    // ARCHIVES - Admin lecture seule (ecriture par CF)
    match /archives/{annee}/{collection}/{docId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // SCHOOLS - Super admin tout, membres de l'ecole lecture
    match /schools/{schoolId} {
      allow read: if isSuperAdmin() ||
        (signedIn() && getUserData().schoolId == schoolId);
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin() ||
        (isAdmin() && getUserData().schoolId == schoolId);
      allow delete: if isSuperAdmin();
    }

    // SCHOOL SUBSCRIPTIONS - Super admin tout, admin de l'ecole lecture
    match /school_subscriptions/{schoolId} {
      allow read: if isSuperAdmin() ||
        (isAdminOrGestionnaire() && getUserData().schoolId == schoolId);
      allow write: if isSuperAdmin();
    }

    // SUPER ADMINS - Lecture seule par les super admins eux-memes
    match /superadmins/{uid} {
      allow read: if isSuperAdmin();
      allow write: if false;
    }

    // ADMISSIONS - Soumission publique, admin de l'ecole gere
    match /admissions/{admissionId} {
      allow create: if true; // formulaire public
      allow read, update, delete: if isAdminOrGestionnaire() &&
        resource.data.schoolId == getUserData().schoolId;
    }

    // TRANSPORT ROUTES - Admin/gestionnaire de l'ecole
    match /transport_routes/{routeId} {
      allow read: if isStaff() && belongsToUserSchool();
      allow write: if isAdminOrGestionnaire() &&
        (resource == null || belongsToUserSchool());
    }

    // LIBRARY / EMPRUNTS - Staff gere, eleves lecture de leurs emprunts
    match /livres/{livreId} {
      allow read: if signedIn();
      allow write: if isAdminOrGestionnaire();
    }

    match /emprunts/{empruntId} {
      allow read: if isStaff() ||
        (isEleve() && resource.data.eleveId == getUserData().eleveId) ||
        (isParent() && resource.data.eleveId in getUserData().enfantsIds);
      allow write: if isStaff();
    }

    // LMS DEVOIRS / SUBMISSIONS
    match /devoirs/{devoirId} {
      allow read: if isStaff() ||
        (isEleve() && resource.data.classe == get(/databases/$(database)/documents/eleves/$(getUserData().eleveId)).data.classe) ||
        isParent();
      allow create, update: if isStaff();
      allow delete: if isAdminOrGestionnaire();
    }

    match /submissions/{submissionId} {
      allow read: if isStaff() ||
        (isEleve() && resource.data.eleveId == getUserData().eleveId);
      allow create: if isEleve() && request.resource.data.eleveId == request.auth.uid;
      allow update: if isStaff();
      allow delete: if isAdminOrGestionnaire();
    }

    // HR - LEAVE REQUESTS
    match /leave_requests/{requestId} {
      allow read: if isAdminOrGestionnaire() ||
        (isStaff() && resource.data.userId == request.auth.uid);
      allow create: if isStaff() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdminOrGestionnaire() ||
        (isStaff() && resource.data.userId == request.auth.uid &&
         resource.data.statut == "en_attente");
      allow delete: if isAdmin();
    }
  }
}
